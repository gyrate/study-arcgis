(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-12a0a3a0"],{"0e25":function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var s=i("c649");class r{constructor(){this.items=[]}addObject(e,t){this.items.push({type:0,objectStateId:t,object:e})}addRenderGeometry(e,t,i){this.items.push({type:1,objectStateId:t,renderGeometry:e,owner:i})}addExternal(e,t){this.items.push({type:2,objectStateId:t,remove:e})}remove(e){for(let t=this.items.length-1;t>=0;--t){const i=this.items[t];i.objectStateId===e&&(this._removeObjectStateItem(i),this.items.splice(t,1))}}removeObject(e){for(let t=this.items.length-1;t>=0;--t){const i=this.items[t];0===i.type&&i.object===e&&(this._removeObjectStateItem(i),this.items.splice(t,1))}}removeRenderGeometry(e){for(let t=this.items.length-1;t>=0;--t){const i=this.items[t];1===i.type&&i.renderGeometry===e&&(this._removeObjectStateItem(i),this.items.splice(t,1))}}removeAll(){this.items.forEach(e=>{this._removeObjectStateItem(e)}),this.items=[]}_removeObjectStateItem(e){switch(e.type){case 0:0===e.objectStateId.channel?e.object.removeHighlight(e.objectStateId):1===e.objectStateId.channel&&e.object.removeOcclude(e.objectStateId);break;case 1:e.owner.removeRenderGeometryObjectState(e.renderGeometry,e.objectStateId);break;case 2:e.remove(e.objectStateId)}}}class a{constructor(e,t){this.stateType=e,this.objectIdField=t,this.objectStateSet=new r,this.ids=new Set,this.paused=!1}hasGraphic(e){if(this.objectIdField){const t=e.graphic.attributes[this.objectIdField];return this.ids.has(t)}return this.ids.has(e.graphic.uid)}}class n{constructor(e){this._graphicsCore=e,this._stateSets=new Array}destroy(){this._stateSets&&this._stateSets.forEach(e=>e.objectStateSet.removeAll()),this._stateSets=null}acquireSet(e,t){const i=new a(e,t);this._stateSets.push(i);const r=Object(s["c"])(()=>this.releaseSet(i));return{set:i,handle:r}}releaseSet(e){e.objectStateSet.removeAll();const t=this._stateSets?this._stateSets.indexOf(e):-1;-1!==t&&this._stateSets.splice(t,1)}_addObjectStateSet(e,t){e.addObjectStateSet(t.stateType,t.objectStateSet)}_removeObjectStateSet(e,t){e.removeObjectState(t.objectStateSet)}setUid(e,t){e.ids.add(t);const i=this._graphicsCore.graphics3DGraphics.get(t);i&&this._addObjectStateSet(i,e)}setUids(e,t){t.forEach(t=>this.setUid(e,t))}setObjectIds(e,t){t.forEach(t=>e.ids.add(t)),this.initializeSet(e)}addGraphic(e){this._stateSets.forEach(t=>{!t.paused&&t.hasGraphic(e)&&this._addObjectStateSet(e,t)})}removeGraphic(e){this._stateSets.forEach(t=>{t.hasGraphic(e)&&this._removeObjectStateSet(e,t)})}allGraphicsDeleted(){this._stateSets&&this._stateSets.forEach(e=>e.objectStateSet.removeAll())}initializeSet(e){const t=this._graphicsCore.graphics3DGraphics;e.objectIdField?t.forEach(t=>{t&&e.hasGraphic(t)&&this._addObjectStateSet(t,e)}):e.ids.forEach(i=>{const s=t.get(i);s&&this._addObjectStateSet(s,e)})}get test(){return{states:this._stateSets}}}},"16d0":function(e,t,i){"use strict";i.d(t,"a",(function(){return l}));var s=i("a4ee"),r=i("e92d"),a=i("59b2"),n=(i("b50f"),i("c120"),i("cea0"),i("d386")),o=i("66a2"),c=i("ee9c");const d=r["a"].getLogger("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView"),l=e=>{let t=class extends e{constructor(){super(...arguments),this._definitionExpressionErrors=0,this._maxDefinitionExpressionErrors=20,this.logError=e=>{this._definitionExpressionErrors<this._maxDefinitionExpressionErrors&&d.error("Error while evaluating definitionExpression: "+e),this._definitionExpressionErrors++,this._definitionExpressionErrors===this._maxDefinitionExpressionErrors&&d.error("Further errors are ignored")}}get parsedDefinitionExpression(){if(!this.i3slayer||!this.i3slayer.definitionExpression)return null;try{const e=o["WhereClause"].create(this.i3slayer.definitionExpression,this.i3slayer.fieldsIndex);if(!e.isStandardized)return d.error("definitionExpression is using non standard function"),null;const t=[],i=e.fieldNames;return Object(c["k"])(i,this.i3slayer.fields,{missingFields:t}),t.length>0?(d.error("definitionExpression references unknown fields: "+t.join(", ")),null):(this._definitionExpressionErrors=0,e)}catch(e){return d.error("Failed to parse definitionExpression: "+e),null}}get definitionExpressionFields(){return this.parsedDefinitionExpression?this.parsedDefinitionExpression.fieldNames:null}_evaluateClause(e,t){try{return e.testFeature(t)}catch(i){return this.logError(i),!1}}_addDefinitionExpressionToQuery(e){if(!this.parsedDefinitionExpression)return e;const t=this.i3slayer.definitionExpression,i=e.clone();return i.where?i.where=`(${t}) AND (${i.where})`:i.where=t,i}};return Object(s["a"])([Object(a["b"])()],t.prototype,"i3slayer",void 0),Object(s["a"])([Object(a["b"])({readOnly:!0})],t.prototype,"parsedDefinitionExpression",null),Object(s["a"])([Object(a["b"])({readOnly:!0})],t.prototype,"definitionExpressionFields",null),t=Object(s["a"])([Object(n["a"])("esri.views.3d.layers.support.DefinitionExpressionSceneLayerView")],t),t}},"5abc":function(e,t,i){"use strict";i.d(t,"a",(function(){return N}));var s=i("a4ee"),r=i("8d60"),a=i("fc29"),n=i("6c97"),o=i("af40"),c=i("f4cc"),d=i("3795"),l=i("59b2"),h=(i("b50f"),i("c120"),i("cea0"),i("d386")),u=i("0f1c"),p=i("9786"),b=i("69dd"),y=i("ed70"),g=i("4c84"),f=i("8202"),O=i("e92d"),m=i("b2b2"),j=i("96d4"),_=i("a207"),v=i("f353"),w=i("9305");const x=O["a"].getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility");let E=class extends a["a"]{constructor(...e){super(...e),this._dirty=!1,this._querying=!1,this._handles=new o["a"]}get updating(){return this._dirty||this._querying||Object(m["l"])(this._queryResult)}setup(e,t){this._layerView=e,this._core=t,this._objectIdField=e.layer.objectIdField,this._queryEngine=new _["a"]({layerView:this._layerView,priority:w["b"].FILTER_VISIBILITY});const i=this._layerView.view.resourceController.scheduler;this._handles.add(i.registerTask(w["b"].FILTER_VISIBILITY,this)),this._handles.add(Object(d["b"])(t.owner,"loadedGraphics","after-changes",e=>this._graphicsChanged(e),()=>this.dirty=!0)),this.filterChanged()}destroy(){this._handles.destroy(),this._handles=null,this.clear(),this._layerView=null,this._core=null}clear(){this._queryEngine.clear()&&(this._core.modifyGraphics3DGraphicVisibilities(e=>e.clearVisibilityFlag(2)),this._queryResult=null,this._querying=!1),this.dirty=!1}_graphicsChanged(e){this._queryEngine&&0==(1&e.type)||(this.dirty=!0)}updateVisibility(e){this.active&&(e.hasVisibilityFlag(2,0)||e.setVisibilityFlag(2,!1,0),this.dirty=!0)}filterChanged(){const e=this.recomputeFilter();e!==this._filter&&(this._filter=e,this.dirty=!0)}get active(){return this._filter&&this._core.graphics3DGraphics.size>0}recomputeFilter(){const e="filter"in this._layerView?this._layerView.filter:null,t="timeExtent"in this._layerView?this._layerView.timeExtent:null,i=Object(v["b"])(this._layerView);if(Object(m["k"])(t)&&Object(m["k"])(i))return e;const s=Object(m["l"])(e)?e.clone():new j["a"];if(Object(m["l"])(t)&&(s.timeExtent=Object(m["l"])(s.timeExtent)?s.timeExtent.intersection(t):t),Object(m["l"])(i)){const e=null==s.where||""===s.where;s.where=e?i:`(${s.where}) AND (${i})`}return s}get running(){return this._dirty&&!this._querying||Object(m["l"])(this._queryResult)}runTask(e){if(!this.active)return void this.clear();!this._dirty||this._querying||e.done||(this._querying=!0,this.dirty=!1,this._queryEngine.executeQueryForIdSet(this._filter).then(e=>{this._queryResult=e,this._querying=!1}).catch(e=>{if(!Object(c["m"])(e)){x.warn("FeatureFilter query failed: "+e,{error:e});const t=new Set;this._core.graphics3DGraphics.forEach(e=>t.add(this._getFeatureId(e.graphic))),this._queryResult=t,this._querying=!1}}),e.madeProgress());const t=this._queryResult;Object(m["l"])(t)&&!e.done&&(this._core.modifyGraphics3DGraphicVisibilities(i=>{if(e.done)return!1;const s=t.has(this._getFeatureId(i.graphic));return!!i.setVisibilityFlag(2,s,0)&&(e.madeProgress(),!0)}),e.done||(this._queryResult=null))}_getFeatureId(e){return null==e.objectId?e.attributes[this._objectIdField]:e.objectId}set dirty(e){this._dirty=e}};Object(s["a"])([Object(l["b"])({readOnly:!0})],E.prototype,"updating",null),Object(s["a"])([Object(l["b"])({readOnly:!0})],E.prototype,"running",null),Object(s["a"])([Object(l["b"])()],E.prototype,"_dirty",void 0),Object(s["a"])([Object(l["b"])()],E.prototype,"_querying",void 0),Object(s["a"])([Object(l["b"])()],E.prototype,"_queryResult",void 0),E=Object(s["a"])([Object(h["a"])("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],E);var S=i("ebae"),I=i("0e25"),C=i("3422"),F=i("ba58"),V=i("d36d"),D=i("d347");let A=class extends a["a"]{constructor(e){super(e),this._handles=new o["a"],this.watchUpdatingTracking=new D["a"],this.suspendResumeExtentMode="computed",this.dataExtent=null,this.suspendResumeExtent=null}get suspended(){var e;return null==(e=this.scaleVisibility)?void 0:e.suspended}get suspendInfo(){var e,t;const i={};return null!=(e=this.scaleVisibility)&&e.suspended&&(i.outsideScaleRange=!0),null!=(t=this.frustumVisibility)&&t.suspended&&(i.outsideOfView=!0),i}get updating(){var e,t,i;return!!(null!=(e=this.graphicsCore)&&e.updating||null!=(t=this.frustumVisibility)&&t.updating||null!=(i=this.watchUpdatingTracking)&&i.updating)}normalizeCtorArgs(e){const t=e.frustumVisibilityEnabled?new S["a"]:null,i=e.scaleVisibilityEnabled?new C["a"]:null,s=(e.filterVisibilityEnabled||e.timeExtentVisibilityEnabled)&&"multipatch"!==e.layer.geometryType?new E:null,r=e.elevationAlignmentEnabled?new f["a"]:null,a=new g["a"]({owner:e.owner,layer:e.layer,preferredUpdatePolicy:e.preferredUpdatePolicy,elevationFeatureExpressionEnabled:e.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:e.owner.hasZ,hasM:e.owner.hasM}),{updateClippingExtent:n,suspendResumeExtentMode:o,dataExtent:c}=e;return{graphicsCore:a,frustumVisibility:t,scaleVisibility:i,filterVisibility:s,elevationAlignment:r,updateClippingExtent:n,suspendResumeExtentMode:o,dataExtent:c}}initialize(){this.scaleVisibility&&this.watchUpdatingTracking.add(this.layer,"scaleRangeId",()=>this.scaleVisibility.layerMinMaxScaleChangeHandler()),this.filterVisibility&&(this.watchUpdatingTracking.add(this.owner,"filter",()=>this.filterVisibility.filterChanged()),this.watchUpdatingTracking.add(this.owner,"timeExtent",()=>this.filterVisibility.filterChanged())),this.elevationAlignment&&this.watchUpdatingTracking.add(this.layer,"elevationInfo",(e,t)=>{Object(u["a"])(e,t)&&this.watchUpdatingTracking.addPromise(this.graphicsCore.elevationInfoChange())}),this.watchUpdatingTracking.add(this.layer,"labelsVisible",()=>this.graphicsCore.updateVisibilityInfo()),this.watchUpdatingTracking.add(this.layer,"labelingInfo",(e,t)=>{Object(u["a"])(e,t)&&this.graphicsCore.updateLabelingInfo()})}async setup(){this.frustumVisibility&&this.frustumVisibility.setup(this.owner);const e=this.owner,t=this.owner.view.basemapTerrain,i=(e,t,i)=>this.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(e,t,i);if(this.scaleVisibility&&this.scaleVisibility.setup(e,this.layer,i,this.graphicsCore,t),this.filterVisibility&&("filter"in e||"timeExtent"in e)&&this.filterVisibility.setup(e,this.graphicsCore),this.elevationAlignment){const t=e.view.elevationProvider;this.elevationAlignment.setup(e,i,this.graphicsCore,t)}this._set("objectStates",new I["a"](this.graphicsCore)),this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility)),this._set("deconfliction",e.view.deconflictor.addGraphicsOwner(this.graphicsCore)),await Object(c["q"])(this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,filterVisibility:this.filterVisibility,deconflictor:this.deconfliction,labeler:this.labeling,objectStates:this.objectStates})),this.watchUpdatingTracking.add(this.layer,"renderer",e=>this.watchUpdatingTracking.addPromise(this.graphicsCore.rendererChange(e))),this.watchUpdatingTracking.add(e,"fullOpacity",()=>this.graphicsCore.opacityChange()),this.setupSuspendResumeExtent(),this.updateClippingExtent&&(this.watchUpdatingTracking.add(e.view,"clippingArea",()=>this._updateClippingExtent()),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&await Object(c["q"])(this.graphicsCore.updateLabelingInfo())}destroy(){this._handles&&(this._handles.destroy(),this._handles=null);const e=["watchUpdatingTracking","frustumVisibility","scaleVisibility","filterVisibility","elevationAlignment","objectStates","graphicsCore"];for(const t of e){const e=this[t];e&&(e.destroy(),this._set(t,null))}this._set("layer",null),this._set("owner",null)}maskOccludee(e){const{set:t,handle:i}=this.objectStates.acquireSet(1,null);return this.objectStates.setUid(t,e.uid),i}highlight(e,t){if(e instanceof b["a"]){const{set:i,handle:s}=this.objectStates.acquireSet(0,t);return this.owner.queryObjectIds(e).then(e=>this.objectStates.setObjectIds(i,e)),s}if("number"==typeof e||"string"==typeof e)return this.highlight([e],t);if(e instanceof r["a"])return this.highlight([e],t);if("toArray"in e&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof r["a"]){const i=e;if(null==Object(V["a"])(this.layer.fieldsIndex,i[0].attributes,t)){const e=i.map(e=>e.uid),{set:t,handle:s}=this.objectStates.acquireSet(0,null);return this.objectStates.setUids(t,e),s}e=i.map(e=>Object(V["a"])(this.layer.fieldsIndex,e.attributes,t))}if("number"==typeof e[0]||"string"==typeof e[0]){const i=e,{set:s,handle:r}=this.objectStates.acquireSet(0,t);return this.objectStates.setObjectIds(s,i),r}}return G}_updateClippingExtent(){const e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this._handles.add(Object(d["a"])(this,"suspendResumeExtentMode",()=>{switch(this._handles.remove(T),this.suspendResumeExtentMode){case"computed":this._handles.add([Object(d["a"])(this.graphicsCore,"computedExtent",e=>this.updateSuspendResumeExtent(e)),this.graphicsCore.watch("extentPadding",()=>this.updateSuspendResumeExtent(this.graphicsCore.computedExtent))],T);break;case"data":this._handles.add([Object(d["a"])(this,"dataExtent",e=>this.updateSuspendResumeExtent(e)),this.graphicsCore.watch("extentPadding",()=>this.updateSuspendResumeExtent(this.dataExtent))],T);break;default:Object(n["a"])(this.suspendResumeExtentMode)}}))}updateSuspendResumeExtent(e){e?this.suspendResumeExtentChanged(this.extentToSuspendResumeRect(e,this.suspendResumeExtent)):this.suspendResumeExtentChanged(null)}extentToSuspendResumeRect(e,t){const i=this.owner.view.spatialReference;if(!e.spatialReference.equals(i)){if(!Object(p["a"])(e,i))return;e=Object(p["d"])(e,i)}return Object(F["e"])(e,t,y["a"],this.graphicsCore.extentPadding)}suspendResumeExtentChanged(e){this.frustumVisibility&&this.frustumVisibility.setExtent(e),this.scaleVisibility&&this.scaleVisibility.setExtent(e)}};Object(s["a"])([Object(l["b"])({aliasOf:"graphicsCore.layer"})],A.prototype,"layer",void 0),Object(s["a"])([Object(l["b"])({aliasOf:"graphicsCore.owner"})],A.prototype,"owner",void 0),Object(s["a"])([Object(l["b"])({constructOnly:!0})],A.prototype,"updateClippingExtent",void 0),Object(s["a"])([Object(l["b"])({constructOnly:!0})],A.prototype,"graphicsCore",void 0),Object(s["a"])([Object(l["b"])({constructOnly:!0})],A.prototype,"scaleVisibility",void 0),Object(s["a"])([Object(l["b"])({constructOnly:!0})],A.prototype,"filterVisibility",void 0),Object(s["a"])([Object(l["b"])({constructOnly:!0})],A.prototype,"elevationAlignment",void 0),Object(s["a"])([Object(l["b"])({constructOnly:!0})],A.prototype,"frustumVisibility",void 0),Object(s["a"])([Object(l["b"])({readOnly:!0})],A.prototype,"deconfliction",void 0),Object(s["a"])([Object(l["b"])({readOnly:!0})],A.prototype,"labeling",void 0),Object(s["a"])([Object(l["b"])({readOnly:!0})],A.prototype,"objectStates",void 0),Object(s["a"])([Object(l["b"])({readOnly:!0})],A.prototype,"watchUpdatingTracking",void 0),Object(s["a"])([Object(l["b"])()],A.prototype,"suspendResumeExtentMode",void 0),Object(s["a"])([Object(l["b"])()],A.prototype,"dataExtent",void 0),Object(s["a"])([Object(l["b"])({readOnly:!0})],A.prototype,"suspended",null),Object(s["a"])([Object(l["b"])({readOnly:!0})],A.prototype,"suspendInfo",null),Object(s["a"])([Object(l["b"])({readOnly:!0,dependsOn:["graphicsCore.updating","frustumVisibility.updating","watchUpdatingTracking.updating"]})],A.prototype,"updating",null),A=Object(s["a"])([Object(h["a"])("esri.views.3d.layers.graphics.Graphics3DFeatureLikeLayerView")],A);const N=A,T="suspendResumeExtentMode",G={remove(){},pause(){},resume(){}}},8202:function(e,t,i){"use strict";i.d(t,"a",(function(){return g}));var s=i("a4ee"),r=i("fc29"),a=i("ce6d"),n=i("af40"),o=i("b2b2"),c=i("59b2"),d=(i("b50f"),i("c120"),i("cea0"),i("d386")),l=i("8a44"),h=i("9180"),u=i("9305");const p=.05;class b{constructor(){this._extents=new l["a"]({allocator:e=>e||Object(h["m"])()}),this._tmpExtent=Object(h["m"])(),this._dirty=!1}get empty(){return 0===this._extents.length}get size(){return this._extents.length}clear(){this._extents.clear()}add(e){this.contains(e)||(this.removeContained(e),Object(h["l"])(this._extents.pushNew(),e),this._dirty=!0)}pop(){return this._dirty&&this.mergeTight(),this._extents.pop()}merge(e){return this.mergeTight(e),e.hasProgressed}mergeTight(e=u["d"]){const t=this._extents,i=new Set;let s=0;for(;s!==t.length;){t.sort((e,t)=>e[0]-t[0]),s=t.length,i.clear();for(let s=0;s<t.length;++s){if(e.done)return;const r=t.getItemAt(s);for(let e=s+1;e<t.length;++e){const s=t.getItemAt(e);if(s[0]>=r[2])break;i.add(s)}i.forEach(s=>{if(r===s)return;if(s[2]<=r[0])return void i.delete(s);const a=Object(h["d"])(r),n=Object(h["d"])(s),o=this._tmpExtent;Object(h["q"])(r,s,o);const c=a+n;(Object(h["d"])(o)-c)/c<p&&(Object(h["l"])(r,o),i.delete(s),t.remove(s),e.madeProgress())}),i.add(r)}}this._dirty=!1}contains(e){return this._extents.some(t=>Object(h["g"])(t,e))}removeContained(e){this._extents.filterInPlace(t=>!Object(h["g"])(e,t))}get test(){const e=this;return{containsPoint:t=>e._extents.some(e=>Object(h["h"])(e,t))}}}let y=class extends r["a"]{constructor(){super(...arguments),this.dirtyExtents=new b,this.globalDirty=!1,this.averageExtentUpdateSize=0,this.dirtyGraphicsSet=new Set,this.handles=new n["a"],this.updateElevation=!1,this.layerView=null,this.graphicsCore=null,this.events=new a["a"]}setup(e,t,i,s){this.layerView=e,this.queryGraphicUIDsInExtent=t,this.graphicsCore=i,this.elevationProvider=s;const r=this.layerView.view.resourceController.scheduler;this.handles.add([s.on("elevation-change",e=>this._elevationChanged(e)),this.layerView.watch("suspended",()=>this.suspendedChange()),r.registerTask(u["b"].ELEVATION_ALIGNMENT,this)])}destroy(){this.dirtyGraphicsSet.clear(),this.handles.destroy(),this.handles=null,this.layerView=null,this.graphicsCore=null,this.queryGraphicUIDsInExtent=null}clear(){this.dirtyGraphicsSet.clear(),this.notifyChange("updating")}suspendedChange(){!0===this.layerView.suspended?this.updateElevation=!1:!1===this.layerView.suspended&&this.updateElevation&&(this.globalDirty=!0,this.notifyChange("updating"))}elevationInfoChange(){this.globalDirty=!0,this.notifyChange("updating")}get updating(){return this.running}get running(){return this.dirtyGraphicsSet.size>0||this.dirtyExtents&&!this.dirtyExtents.empty||this.globalDirty}get updatingRemaining(){return this.dirtyGraphicsSet.size+this.dirtyExtents.size*this.averageExtentUpdateSize}runTask(e){for(this.globalDirty&&(this.markAllGraphicsElevationDirty(),this.globalDirty=!1,e.madeProgress()),e.run(()=>this.dirtyExtents.merge(e));this.running&&!e.done;)this._updateDirtyGraphics(e),this._updateDirtyExtents(e);this.layerView.view.deconflictor.setDirty(),this.notifyChange("updating")}_updateDirtyGraphics(e){const t=this.layerView.view.renderCoordsHelper,i=0===this.graphicsCore.effectiveUpdatePolicy;for(const s of this.dirtyGraphicsSet.keys()){const r=this.graphicsCore.getGraphics3DGraphicById(s);if(this.dirtyGraphicsSet.delete(s),Object(o["l"])(r)&&(r.alignWithElevation(this.elevationProvider,t,i),e.madeProgress()),e.done)return}}_updateDirtyExtents(e){for(;!this.dirtyExtents.empty&&!e.done;){const t=this.dirtyExtents.pop(),i=this.elevationProvider.spatialReference;this.events.emit("invalidate-elevation",{extent:t,spatialReference:i});const s=this.dirtyGraphicsSet.size;this.queryGraphicUIDsInExtent(t,i,e=>{const t=this.graphicsCore.getGraphics3DGraphicById(e);Object(o["l"])(t)&&t.needsElevationUpdates()&&this.dirtyGraphicsSet.add(e)}),this.averageExtentUpdateSize=.1*(this.dirtyGraphicsSet.size-s)+.9*this.averageExtentUpdateSize,e.madeProgress()}}markAllGraphicsElevationDirty(){this.dirtyExtents.clear(),this.dirtyGraphicsSet.clear(),this.graphicsCore.graphics3DGraphics.forEach((e,t)=>this.dirtyGraphicsSet.add(t))}_elevationChanged(e){if("scene"===e.context&&(!this.graphicsCore.layer.elevationInfo||"relative-to-scene"!==this.graphicsCore.layer.elevationInfo.mode))return;const{extent:t,spatialReference:i}=e;if(this.layerView.suspended){if(!this.updateElevation){const e=this.graphicsCore.computedExtent;e&&t[2]>e.xmin&&t[0]<e.xmax&&t[3]>e.ymin&&t[1]<e.ymax&&(this.updateElevation=!0)}this.events.emit("invalidate-elevation",{extent:t,spatialReference:i})}else t[0]===-1/0?this.globalDirty=!0:this.dirtyExtents.add(t),this.notifyChange("updating")}};Object(s["a"])([Object(c["b"])({readOnly:!0})],y.prototype,"updating",null),Object(s["a"])([Object(c["b"])({readOnly:!0})],y.prototype,"updatingRemaining",null),y=Object(s["a"])([Object(d["a"])("esri.views.3d.layers.graphics.Graphics3DElevationAlignment")],y);const g=y},a207:function(e,t,i){"use strict";i.d(t,"a",(function(){return y}));var s=i("a4ee"),r=(i("e06a"),i("fc29")),a=i("b2b2"),n=i("59b2"),o=(i("b50f"),i("c120"),i("cea0"),i("d386")),c=i("3af1"),d=i("6411"),l=i("2edc"),h=i("69dd"),u=i("74e2");const p=d["a"];let b=class extends r["a"]{constructor(e){super(e),this._dataQueryEngineInstance=null}get queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new h["a"]({outSpatialReference:this.spatialReference}).toJSON()}get dataQueryEngine(){return this.ensureDataQueryEngine()}destroy(){this.clear()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(e,t){return this.dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e),t)}async executeQueryForCount(e,t){return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:i,extent:s}=await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:i,extent:c["a"].fromJSON(s)}}async executeQueryForIds(e,t){return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQueryForLatestObservations(e,t){const i=await this.dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),t),s=l["default"].fromJSON(i);return s.features.forEach(e=>{e.layer=this.layer,e.sourceLayer=this.layer}),s}async executeQuery(e,t){const i=await this.dataQueryEngine.executeQuery(this._ensureQueryJSON(e),t),s=l["default"].fromJSON(i);return s.features.forEach(e=>{e.layer=this.layer,e.sourceLayer=this.layer}),s}_ensureQueryJSON(e){return Object(a["k"])(e)?this.defaultQueryJSON:("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),e.toJSON())}ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e="timeInfo"in this.layer&&this.layer.timeInfo&&this.layer.timeInfo.toJSON()||null,t=this.layer.objectIdField,i=u["a"].toJSON(this.queryGeometryType),s=this.layer.fields.map(e=>e.toJSON()),r=this.layerView.view.resourceController.scheduler,a=this.priority,n=this.spatialReference.toJSON(),o=this.layerView.graphics3d.graphicsCore.featureStore,{hasZ:c,hasM:d}=this.layerView;return this._dataQueryEngineInstance=new p({hasZ:c,hasM:d,geometryType:i,fields:s,timeInfo:e,spatialReference:n,objectIdField:t,featureStore:o,scheduler:r,priority:a}),this._dataQueryEngineInstance}};Object(s["a"])([Object(n["b"])({constructOnly:!0})],b.prototype,"layerView",void 0),Object(s["a"])([Object(n["b"])({constructOnly:!0})],b.prototype,"priority",void 0),Object(s["a"])([Object(n["b"])({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],b.prototype,"spatialReference",void 0),Object(s["a"])([Object(n["b"])({readOnly:!0,aliasOf:"layerView.layer"})],b.prototype,"layer",void 0),Object(s["a"])([Object(n["b"])({readOnly:!0})],b.prototype,"queryGeometryType",null),Object(s["a"])([Object(n["b"])({readOnly:!0})],b.prototype,"defaultQueryJSON",null),b=Object(s["a"])([Object(o["a"])("esri.views.3d.layers.graphics.QueryEngine")],b);const y=b},ad73:function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"b",(function(){return a}));var s=i("b2b2"),r=i("c1da");async function a(e,t=e.popupTemplate){if(!Object(s["l"])(t))return[];const i=await t.getRequiredFields(e.fieldsIndex),{lastEditInfoEnabled:a}=t,{objectIdField:n,typeIdField:o,globalIdField:c,relationships:d}=e;if(i.includes("*"))return["*"];const l=a?await Object(r["n"])(e):[],h=Object(r["j"])(e.fieldsIndex,[...i,...l]);return o&&h.push(o),h&&n&&e.fieldsIndex.has(n)&&-1===h.indexOf(n)&&h.push(n),h&&c&&e.fieldsIndex.has(c)&&-1===h.indexOf(c)&&h.push(c),d&&d.forEach(t=>{const{keyField:i}=t;h&&i&&e.fieldsIndex.has(i)&&-1===h.indexOf(i)&&h.push(i)}),h}function n(e,t){return e.popupTemplate?e.popupTemplate:Object(s["l"])(t)&&t.defaultPopupTemplateEnabled&&Object(s["l"])(e.defaultPopupTemplate)?e.defaultPopupTemplate:null}},bb87:function(e,t,i){"use strict";i.d(t,"a",(function(){return f}));var s=i("a4ee"),r=i("fc29"),a=i("e92d"),n=i("c0d3"),o=i("59b2"),c=i("d386"),d=i("cb26");const l=e=>{let t=class extends e{constructor(){super(...arguments),this._numUpdating=0,this.asyncUpdateState=new Map}get updating(){return this._numUpdating>0}autoUpdateAsync(e,t){return h(t=>this.updateAsync(e,t),t)}async updateAsync(e,i){if(!this.startAsyncUpdate(e)){try{const t=await i();this._set(e,t)}catch(t){a["a"].getLogger(this.declaredClass).warn(`Async update of "${e}" failed. Async update functions should not throw exceptions.`)}this.endAsyncUpdate(e)&&this.updateAsync(e,i)}}startAsyncUpdate(e){var t;const i=null!=(t=this.asyncUpdateState.get(e))?t:0;return 1&i?(this.asyncUpdateState.set(e,2|i),!0):(++this._numUpdating,this.asyncUpdateState.set(e,1|i),!1)}endAsyncUpdate(e){var t;--this._numUpdating;const i=-2&(null!=(t=this.asyncUpdateState.get(e))?t:0);return 2&i?(this.asyncUpdateState.set(e,-3&i),!0):(this.asyncUpdateState.set(e,i),!1)}};return Object(s["a"])([Object(o["b"])({readOnly:!0})],t.prototype,"updating",null),Object(s["a"])([Object(o["b"])()],t.prototype,"_numUpdating",void 0),t=Object(s["a"])([Object(c["a"])("esri.core.AsyncUpdate")],t),t};function h(e,t){const i=()=>{a&&!o&&e(s)},s=()=>{if(!a||o)return t();a.clear(),o=!0;const e=Object(n["b"])(a,t);return o=!1,e},r=()=>{a&&(a.destroy(),a=null)};let a=new d["a"](i),o=!1;return e(s),{remove:r}}let u=class extends(l(r["a"])){};u=Object(s["a"])([Object(c["a"])("esri.core.AsyncUpdate")],u);var p=i("9096"),b=i("b2b2"),y=(i("b50f"),i("c120"),i("cea0"),i("c1da"));const g=a["a"].getLogger("esri.views.3d.layers.support.SceneLayerViewRequiredFields");let f=class extends(l(p["a"])){constructor(e){super(e)}get requiredFields(){const{layerView:{layer:{fieldsIndex:e},definitionExpressionFields:t},rendererFields:i,labelingFields:s,viewFilterFields:r}=this;return Object(y["j"])(e,[...Object(b["v"])(t,[]),...Object(b["v"])(i,[]),...Object(b["v"])(s,[]),...Object(b["v"])(r,[])])}initialize(){const e=this.layerView.layer;this.layer=e,this.handles.add([this.autoUpdateAsync("rendererFields",()=>{const{fieldsIndex:e,renderer:t}=this.layer;return t?O(i=>t.collectRequiredFields(i,e)):null}),this.autoUpdateAsync("labelingFields",()=>{const{layer:e}=this;return e.labelsVisible?O(t=>Object(y["g"])(t,e)):null}),this.autoUpdateAsync("viewFilterFields",()=>{const{layer:e,filter:t}=this.layerView;return O(i=>Object(y["f"])(i,e,t))})])}};async function O(e){const t=new Set;try{return await e(t),Array.from(t).sort()}catch(i){return g.error(i),null}}Object(s["a"])([Object(o["b"])()],f.prototype,"layerView",void 0),Object(s["a"])([Object(o["b"])()],f.prototype,"layer",void 0),Object(s["a"])([Object(o["b"])()],f.prototype,"requiredFields",null),Object(s["a"])([Object(o["b"])()],f.prototype,"rendererFields",void 0),Object(s["a"])([Object(o["b"])()],f.prototype,"labelingFields",void 0),Object(s["a"])([Object(o["b"])()],f.prototype,"viewFilterFields",void 0),f=Object(s["a"])([Object(c["a"])("esri.views.3d.layers.support.SceneLayerViewRequiredFields")],f)},c572:function(e,t,i){"use strict";i.r(t),i.d(t,"default",(function(){return L}));var s=i("a4ee"),r=i("8d60"),a=i("e92d"),n=i("b2b2"),o=i("3795"),c=i("59b2"),d=(i("b50f"),i("c120"),i("cea0"),i("d386")),l=i("e431"),h=i("0b2d"),u=i("8188"),p=i("9180"),b=i("2172"),y=i("b0f5"),g=i("1a54"),f=i("d3cf"),O=i("38a2"),m=i("96d4"),j=i("d1ac"),_=i("69dd"),v=i("78ba");class w extends v["a"]{constructor(e){super("SceneLayerWorker","dracoDecompressPointCloudData",e,{hasInitialize:!0})}getTransferList(e){return[e.geometryBuffer]}}var x=i("66af"),E=i("5abc"),S=i("a207"),I=i("dd25"),C=i("d5bc"),F=i("ee9c"),V=i("16d0"),D=i("f426"),A=i("f7f0"),N=i("bb87"),T=i("6611"),G=i("e411"),R=i("cee3"),U=i("deae"),q=i("e315"),k=i("9305");const P=a["a"].getLogger("esri.views.3d.layers.SceneLayerGraphicsView3D"),Q=Object(D["a"])();let M=class extends(Object(V["a"])(Object(A["a"])(Object(x["a"])(q["a"])))){constructor(){super(...arguments),this.type="scene-layer-graphics-3d",this._nodesAddedToStage=new Map,this.drapeSourceType=1,this._queryEngine=null,this._memCache=null,this._interactiveEditingSessions=new Map,this.loadedGraphics=new G["a"],this.holeFilling="always",this.progressiveLoadFactor=1,this.supportsHeightUnitConversion=!0,this._coordinatesOutsideExtentErrors=0,this._maxCoordinatesOutsideExtentErrors=20}initialize(){var e,t;const s=this.layer;this.addResolvingPromise(s.indexInfo),this._attributeOverrides=new C["a"](this.layer,null==(e=this.view.resourceController)?void 0:e.memoryController),Object(F["g"])(s,this.view.spatialReference,this.view.viewingMode),this.fieldsHelper=new N["a"]({layerView:this}),this.updatingHandles.add(s,"rangeInfos",e=>this._rangeInfosChanged(e),2),this.updatingHandles.add(s,"renderer",(e,t)=>this._rendererChange(e,t)),this.updatingHandles.add(this,"parsedDefinitionExpression",()=>this._filterChange()),this.updatingHandles.add(this,"view.floors",()=>this.graphics3d.filterVisibility.filterChanged()),this.handles.add(Object(o["a"])(T["a"],"I3S_TREE_SHOW_TILES",e=>{if(e&&!this._treeDebugger){const e=this._controller.crsIndex;i.e("chunk-71e77862").then(i.bind(null,"4d47")).then(({I3STreeDebugger:t})=>{!this._treeDebugger&&T["a"].I3S_TREE_SHOW_TILES&&(this._treeDebugger=new t({lv:this,view:this.view,nodeSR:e}))})}else e||!this._treeDebugger||T["a"].I3S_TREE_SHOW_TILES||(this._treeDebugger.destroy(),this._treeDebugger=null)})),this._set("graphics3d",new E["a"]({owner:this,layer:s,preferredUpdatePolicy:0,scaleVisibilityEnabled:!0,filterVisibilityEnabled:!0,timeExtentVisibilityEnabled:!1,frustumVisibilityEnabled:!1,elevationAlignmentEnabled:!0,elevationFeatureExpressionEnabled:!1,suspendResumeExtentMode:"data",dataExtent:s.fullExtent,updateClippingExtent:e=>this._updateClippingExtent(e)})),null==(t=this.graphics3d.elevationAlignment)||t.events.on("invalidate-elevation",e=>this._invalidateElevation(e)),this.supportsHeightUnitConversion&&(this._verticalScale=Object(y["a"])("point",s.spatialReference,this.view.spatialReference)),this.addResolvingPromise(this.graphics3d.setup()),this._memCache=this.view.resourceController.memoryController.newCache(s.uid),this._controller=new O["a"]({layerView:this,scaleVisibilityEnabled:!1}),Object(F["i"])(this.layer.geometryDefinitions)&&(this._worker=new w(e=>this.view.resourceController.schedule(e))),this.handles.add(this.layer.on("apply-edits",e=>this.updatingHandles.addPromise(e.result))),this.handles.add(this.layer.on("edits",e=>this._handleEdits(e))),this.when(()=>{this._queryEngine=new S["a"]({layerView:this,priority:k["b"].FEATURE_QUERY_ENGINE}),this.updatingHandles.add(this,"maximumNumberOfFeatures",e=>this._controller.featureTarget=e,2),this.updatingHandles.add(this,"suspended",e=>{e&&this._removeAllNodeData()})})}destroy(){this._treeDebugger=Object(n["e"])(this._treeDebugger),this._attributeOverrides=Object(n["e"])(this._attributeOverrides),this._set("graphics3d",Object(n["e"])(this.graphics3d)),this._controller=Object(n["e"])(this._controller),this._queryEngine=Object(n["e"])(this._queryEngine),this._worker=Object(n["e"])(this._worker),this._memCache=Object(n["e"])(this._memCache),this._nodesAddedToStage.clear(),this.fieldsHelper=Object(n["e"])(this.fieldsHelper)}get requiredFields(){var e,t;return null!=(e=null==(t=this.fieldsHelper)?void 0:t.requiredFields)?e:[]}get maximumNumberOfFeatures(){const e=this.graphics3d&&this.graphics3d.graphicsCore&&this.graphics3d.graphicsCore.displayFeatureLimit;return e?e.maximumNumberOfFeatures:0}set maximumNumberOfFeatures(e){null!=e?(this._override("maximumNumberOfFeatures",e),this._controller.fixedFeatureTarget=!0):(this._clearOverride("maximumNumberOfFeatures"),this._controller.fixedFeatureTarget=!1)}get maximumNumberOfFeaturesExceeded(){return!this.suspended&&!!this._controller&&!this._controller.leavesReached}get hasM(){return!1}get hasZ(){return!0}notifyGraphicGeometryChanged(e){this.graphics3d.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphics3d.graphicsCore.notifyGraphicVisibilityChanged(e)}async whenGraphicAttributes(e,t){return Object(F["x"])(this.layer,e,this._getObjectIdField(),t,()=>[...this._nodesAddedToStage.values()])}getGraphicFromGraphicUid(e){if(!this.loadedGraphics)return null;const t=Object(f["c"])(this.loadedGraphics.find(t=>t.uid===e),this.layer),i=this._getObjectIdField();return t&&t.attributes&&t.attributes[i]?(t.layer=this.layer,t.sourceLayer=this.layer,t):null}whenGraphicBounds(e,t){return this.graphics3d.graphicsCore.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.graphics3d.graphicsCore.computeAttachmentOrigin(e,t)}canResume(){return super.canResume()&&(!this._controller||this._controller.rootNodeVisible)}isUpdating(){var e,t,i;return!!(null!=(e=this._controller)&&e.updating||null!=(t=this.graphics3d)&&t.updating||null!=(i=this.fieldsHelper)&&i.updating)}getRenderingInfo(e,t,i){const s=Object(j["c"])(e,{renderer:t,arcade:i});if(Object(n["l"])(s)&&s.color){const e=s.color;e[0]=e[0]/255,e[1]=e[1]/255,e[2]=e[2]/255}return s}async getRenderingInfoAsync(e,t,i,s){return Object(j["d"])(e,{renderer:t,arcade:i,...s})}get symbolUpdateType(){return this.graphics3d.graphicsCore.symbolUpdateType}highlight(e){return this.graphics3d.highlight(e,this.layer.objectIdField)}get updatePolicy(){return this.graphics3d.graphicsCore.effectiveUpdatePolicy}createInteractiveEditSession(e){return Object(I["a"])(this.attributeEditingContext,e)}async extractBinaryPointData(e,t){const i={geometryBuffer:e.geometryBuffer};return Object(n["k"])(this._worker)&&(this._worker=new w(e=>this.view.resourceController.schedule(e))),this._worker.invoke(i,t).then(e=>{if(Object(n["l"])(e))return{positionData:e.positions,featureIds:e.featureIds};throw new Error("Failed to decompress Draco point data")})}checkExtent(e,t){e&&!Object(b["b"])(e,t)&&(this._coordinatesOutsideExtentErrors<this._maxCoordinatesOutsideExtentErrors&&P.error("Service Error: Coordinates outside of layer extent"),this._coordinatesOutsideExtentErrors+1===this._maxCoordinatesOutsideExtentErrors&&P.error("Maximum number of errors reached. Further errors are ignored."),this._coordinatesOutsideExtentErrors++)}async addNode(e,t,i){if(!z(t)&&!B(t))return Promise.reject();if(this._nodesAddedToStage.has(e.index))return void P.error("I3S node "+e.id+" already added");const s=Object(n["l"])(this.layer.fullExtent)?J(this.layer.fullExtent.clone(),.5):null,r=this._controller.crsVertex,a=[],o={graphics:null,featureIds:null,attributeInfo:t.attributeDataInfo,node:e};if(z(t)?await this._addNodeBinaryPointData(e,o,t,s,a,i):B(t)&&this._addNodeLegacyPointData(e,o,t,s,a),await this._attributeOverrides.apply(o.featureIds,t.attributeDataInfo,i),e.numFeatures=o.graphics.length,this._updateNodeMemory(e),H(o),a.length>0&&(this.computeObb(e,a,r),this._controller.updateVisibility(e.index)),!this._controller.isGeometryVisible(e))return this._cacheNodeData(o),Promise.resolve();if(Object(n["l"])(this._verticalScale))for(const n of o.graphics)this._verticalScale(n.geometry);return this._nodesAddedToStage.set(e.index,o),this.loadedGraphics.addMany(o.graphics),this._filterNode(o),this._treeDebugger&&this._treeDebugger.update(),Promise.resolve()}computeObb(e,t,i){const s=this._controller.crsIndex,r=s.isGeographic?this.view.renderSpatialReference:s;Object(u["p"])(t,i,0,t,r,0,t.length/3);const a={data:t,size:3};e.serviceObb=Object(R["c"])(a),s.isGeographic&&Object(u["y"])(e.serviceObb.center,r,e.serviceObb.center,s)}isNodeLoaded(e){return this._nodesAddedToStage.has(e)}isNodeReloading(){return!1}updateNodeState(){}async _addNodeBinaryPointData(e,t,i,s,a,o){const c=await this.extractBinaryPointData(i,o);if(null==c)return Promise.reject();const d=this._getObjectIdField(),p=this._controller.crsVertex,b=this.view.spatialReference,y=this.graphics3d.graphicsCore,{positionData:f,featureIds:O}=c,m=3,j=f.length/m,_=new Array;for(let v=0;v<j;v++){const t=Object(n["l"])(e.serviceObb)?e.serviceObb.center:[0,0,0],i=v*m,o=Object(h["h"])(f[i+0],f[i+1],f[i+2]);Object(l["i"])(o,o,t),e.serviceObb||a.push(o[0],o[1],o[2]),Object(n["l"])(s)&&this.checkExtent(s,o);const c=O[v],j={};null!=c&&(j[d]=c);const w=null==c?r["a"].generateUID():c;Object(u["p"])(o,p,0,W,b,0,1);const x=Object(g["j"])(W[0],W[1],W[2],b),E=this.loadedGraphics.get(w);if(Object(n["l"])(E))E.level<e.level&&($.property="geometry",$.graphic=E,$.oldValue=Object(n["u"])(E.geometry),$.newValue=x,E.geometry=x,y.graphicUpdateHandler($)),_.push(E);else{const t=r["a"].generateUID();_.push({objectId:w,uid:t,geometry:x,attributes:j,visible:!0,level:e.level})}}t.graphics=_,t.featureIds=O}_addNodeLegacyPointData(e,t,i,s,a){const o=this._getObjectIdField(),c=this._controller.crsVertex,d=this.view.spatialReference,l=[0,0,0],h=new Array,p=new Array;for(const b of i.pointData){const t=b.featureDataPosition,i=t.length,y=b.geometries&&b.geometries[0]||Z[i],f=b.featureIds[0];if("points"!==y.params.type)continue;Object(n["l"])(s)&&this.checkExtent(s,t);const O={};null!=f&&(O[o]=f);const m=null==f?r["a"].generateUID():f;let j;"Embedded"===y.type&&(j=y.params.vertexAttributes.position);for(let s=0;s<j.length;s+=i){for(let e=0;e<i;e++)l[e]=t[e]+j[s+e];const o=3===i;e.serviceObb||a.push(l[0],l[1],o?l[2]:0),Object(u["p"])(l,c,0,W,d,0,1);const h=Object(g["j"])(W[0],W[1],o?W[2]:void 0,d),b=this.loadedGraphics.get(m);Object(n["l"])(b)?p.push(b):p.push({objectId:m,uid:r["a"].generateUID(),geometry:h,attributes:O,visible:!0})}h.push(f)}t.graphics=p,t.featureIds=h}_updateNodeMemory(e){e.memory=4096+(Object(n["l"])(e.numFeatures)?e.numFeatures*this.graphics3d.graphicsCore.usedMemoryPerGraphic:0)}_cacheNodeData(e){const t=e.graphics.reduce((e,t)=>Object(g["e"])(t)+e,512+8*e.featureIds.length+1024);this._memCache.put(this._getMemCacheKey(e.node),e,t)}_getMemCacheKey(e){return""+e.index}_removeAllNodeData(){this._nodesAddedToStage.forEach(e=>{if(e){const t=e.node;this._updateNodeMemory(t),this._cacheNodeData(e)}}),this._nodesAddedToStage.clear(),this._treeDebugger&&this._treeDebugger.update(),this.loadedGraphics.clear()}removeNode(e){const t=this._removeNodeStageData(e);t&&(this._updateNodeMemory(t.node),this._cacheNodeData(t))}_removeNodeStageData(e){const t=this._nodesAddedToStage.get(e);return t?(this.loadedGraphics.removeMany(t.graphics),this._nodesAddedToStage.delete(e),this._treeDebugger&&this._treeDebugger.update(),t):null}async loadCachedNodeData(e){return this._memCache.pop(this._getMemCacheKey(e))}async addCachedNodeData(e,t,i,s){if(!this._nodesAddedToStage.has(e.index))return this.loadedGraphics.addMany(t.graphics),this._nodesAddedToStage.set(e.index,t),this._updateNodeMemory(e),await this.updateAttributes(e.index,i,s),this._filterNode(t),this._treeDebugger&&this._treeDebugger.update(),Promise.resolve();P.error("I3S node "+e.id+" already added")}getLoadedNodeIds(){const e=[];return this._nodesAddedToStage.forEach(t=>e.push(t.node.id)),e.sort()}getVisibleNodes(){const e=new Array;return this._nodesAddedToStage.forEach(t=>e.push(t.node)),e}getLoadedNodeIndices(e){this._nodesAddedToStage.forEach((t,i)=>e.push(i))}getLoadedAttributes(e){const t=this._nodesAddedToStage.get(e);if(t&&Object(n["l"])(t.attributeInfo))return t.attributeInfo.loadedAttributes}getAttributeData(e){const t=this._nodesAddedToStage.get(e);if(t&&Object(n["l"])(t.attributeInfo))return t.attributeInfo.attributeData}setAttributeData(e,t){const i=this._nodesAddedToStage.get(e);i&&!Object(n["k"])(i.attributeInfo)&&(i.attributeInfo.attributeData=t,this._attributeValuesChanged(i))}async updateAttributes(e,t,i){const s=this._nodesAddedToStage.get(e);s&&(await this._attributeOverrides.apply(s.featureIds,t,i),s.attributeInfo=t,this._attributeValuesChanged(s))}_attributeValuesChanged(e){if(H(e),this._filterNode(e),this.graphics3d.graphicsCore.labelsEnabled){const t=e.graphics.map(e=>e.uid);this.graphics3d.graphicsCore.updateLabelingInfo(t)}}_updateClippingExtent(e){return this._controller&&this._controller.updateClippingArea(e),!1}_getObjectIdField(){return this.layer.objectIdField||"OBJECTID"}async _rendererChange(e,t){const{layer:{fieldsIndex:i}}=this,s=new Set;let r,a;e?(await e.collectRequiredFields(s,i),r=Array.from(s).sort()):r=[],s.clear(),t?(await t.collectRequiredFields(s,i),a=Array.from(s).sort()):a=[],r.length===a.length&&r.every((e,t)=>r[t]===a[t])||this._reloadAllNodes()}_rangeInfosChanged(e){null!=e&&e.length>0&&P.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")}_filterChange(){this._nodesAddedToStage.forEach(e=>this._filterNode(e))}_reloadAllNodes(){this._removeAllNodeData(),this._controller&&this._controller.restartNodeLoading()}_filterNode(e){const t=this.parsedDefinitionExpression;for(const i of e.graphics){const e=i.visible;i.visible=!t||this._evaluateClause(t,i),e!==i.visible&&($.graphic=i,$.property="visible",$.oldValue=e,$.newValue=i.visible,this.graphics3d.graphicsCore.graphicUpdateHandler($))}}_invalidateElevation(e){const t=this._controller.crsIndex;Object(u["n"])(e.extent,e.spatialReference,Y,t),this._controller.updateElevationChanged(Y,t)}createQuery(){const e={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return Object(n["l"])(this.filter)?this.filter.createQuery(e):new _["a"](e)}queryFeatures(e,t){return this._queryEngine.executeQuery(this._ensureQuery(e),null==t?void 0:t.signal)}queryObjectIds(e,t){return this._queryEngine.executeQueryForIds(this._ensureQuery(e),null==t?void 0:t.signal)}queryFeatureCount(e,t){return this._queryEngine.executeQueryForCount(this._ensureQuery(e),null==t?void 0:t.signal)}queryExtent(e,t){return this._queryEngine.executeQueryForExtent(this._ensureQuery(e),null==t?void 0:t.signal)}_ensureQuery(e){return this._addDefinitionExpressionToQuery(Object(n["k"])(e)?this.createQuery():_["a"].from(e))}getUsedMemory(){const e=this.graphics3d&&this.graphics3d.graphicsCore;return e?e.usedMemory:0}getUnloadedMemory(){const e=this.graphics3d&&this.graphics3d.graphicsCore;return.8*((this._controller?this._controller.unloadedMemoryEstimate:0)+(e?e.unprocessedMemoryEstimate:0))}ignoresMemoryFactor(){return this._controller&&this._controller.fixedFeatureTarget}_handleEdits(e){Object(I["b"])(this.attributeEditingContext,e)}get attributeEditingContext(){const e=this._getObjectIdField();return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:e,forEachNode:e=>this._nodesAddedToStage.forEach(t=>e(t.node,t.featureIds)),attributeStorageInfo:this.i3slayer.attributeStorageInfo,attributeOverrides:this._attributeOverrides,getAttributeData:e=>this.getAttributeData(e),setAttributeData:(t,i,s)=>{this.setAttributeData(t,i);const r=this._nodesAddedToStage.get(t);if(Object(n["l"])(s)){const t=this.loadedGraphics.get(s.attributes[e]);Object(n["l"])(t)&&this.graphics3d.graphicsCore.recreateGraphics([t])}else Object(n["l"])(r)&&this.graphics3d.graphicsCore.recreateGraphics(r.graphics)},clearMemCache:()=>{}}}get performanceInfo(){const e={displayedNumberOfFeatures:this.loadedGraphics.length,maximumNumberOfFeatures:this.maximumNumberOfFeatures,totalNumberOfFeatures:-1,nodes:this._nodesAddedToStage.size,core:this.graphics3d.graphicsCore.performanceInfo};return this._controller&&this._controller.updateStats(e),e}get test(){return{controller:this._controller,numNodes:this._nodesAddedToStage.size,numFeatures:this.loadedGraphics.length}}};Object(s["a"])([Object(c["b"])()],M.prototype,"graphics3d",void 0),Object(s["a"])([Object(c["b"])({type:m["a"]})],M.prototype,"filter",void 0),Object(s["a"])([Object(c["b"])()],M.prototype,"loadedGraphics",void 0),Object(s["a"])([Object(c["b"])({aliasOf:"layer"})],M.prototype,"i3slayer",void 0),Object(s["a"])([Object(c["b"])()],M.prototype,"_controller",void 0),Object(s["a"])([Object(c["b"])()],M.prototype,"updating",void 0),Object(s["a"])([Object(c["b"])()],M.prototype,"suspended",void 0),Object(s["a"])([Object(c["b"])()],M.prototype,"holeFilling",void 0),Object(s["a"])([Object(c["b"])(U["a"])],M.prototype,"updatingProgress",void 0),Object(s["a"])([Object(c["b"])({aliasOf:"_controller.updatingProgress"})],M.prototype,"updatingProgressValue",void 0),Object(s["a"])([Object(c["b"])(Q.requiredFields)],M.prototype,"requiredFields",null),Object(s["a"])([Object(c["b"])(Q.availableFields)],M.prototype,"availableFields",void 0),Object(s["a"])([Object(c["b"])()],M.prototype,"fieldsHelper",void 0),Object(s["a"])([Object(c["b"])({type:Number})],M.prototype,"maximumNumberOfFeatures",null),Object(s["a"])([Object(c["b"])({readOnly:!0})],M.prototype,"maximumNumberOfFeaturesExceeded",null),Object(s["a"])([Object(c["b"])({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.point.lodFactor"})],M.prototype,"lodFactor",void 0),Object(s["a"])([Object(c["b"])({readOnly:!0})],M.prototype,"hasM",null),Object(s["a"])([Object(c["b"])({readOnly:!0})],M.prototype,"hasZ",null),M=Object(s["a"])([Object(d["a"])("esri.views.3d.layers.SceneLayerGraphicsView3D")],M);const L=M;function B(e){return"pointData"in e}function z(e){return"geometryBuffer"in e&&null!==e.geometryBuffer}function H(e){const t=e.attributeInfo;for(let i=0;i<e.graphics.length;i++){const s=e.graphics[i];if(s.attributes||(s.attributes={}),Object(n["l"])(t)&&Object(n["l"])(t.loadedAttributes))for(const{name:e}of t.loadedAttributes)t.attributeData[e]&&(s.attributes[e]=Object(F["n"])(t.attributeData[e],i))}}function J(e,t){return e.xmin-=t,e.ymin-=t,e.xmax+=t,e.ymax+=t,e.hasZ&&(e.zmin-=t,e.zmax+=t),e.hasM&&(e.mmin-=t,e.mmax+=t),e}const Z={2:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0]}}},3:{type:"Embedded",params:{type:"points",vertexAttributes:{position:[0,0,0]}}}},W=Object(h["f"])(),$={graphic:null,property:null,oldValue:null,newValue:null},Y=Object(p["m"])()},dd25:function(e,t,i){"use strict";i.d(t,"a",(function(){return o})),i.d(t,"b",(function(){return c}));var s=i("7ffa"),r=i("b2b2"),a=i("d36d");const n={setAttribute(){},rollback(){},commit(){}};function o(e,t){const i=t.attributes[e.objectIdField],a=e.sessions.get(i);if(a)return a;const o=Object(s["a"])(t.attributes),c=new Set;if(null==i)return n;const d=e.attributeOverrides.createInteractiveEditSession(i),l=new Map,h=(e,t)=>{const s=l.get(e);if(null==s){const s=t.indexOf(i);return l.set(e,s),s}return s};let u=0;const p={setAttribute(i,s){if(0!==u)return;const a=e.fieldsIndex.get(i);if(Object(r["k"])(a))return;const n=e.attributeStorageInfo.findIndex(e=>e.name===a.name);if(n<0)return;d.set(n,s);const o=e.attributeStorageInfo[n];let l=!1;c.add(i),e.forEachNode((i,r)=>{const a=h(i,r);if(-1===a)return;const n=e.getAttributeData(i.index);if(n){const r=n[o.name];r&&(r[a]=s,e.setAttributeData(i.index,n,t),l=!0)}}),l&&e.clearMemCache()},rollback(){if(0===u){for(const e of c)this.setAttribute(e,o[e]);d.rollback(),u=1,e.sessions.delete(i)}},commit(){0===u&&(d.commit(),u=2,e.sessions.delete(i))}};return e.sessions.set(i,p),p}function c(e,t){const i=d(e,t);if(0===i.size)return;const s=new Map;for(let r=0;r<e.attributeStorageInfo.length;r++)s.set(e.attributeStorageInfo[r].name,r);let a=!1;i.forEach((t,i)=>{const n=e.getAttributeData(i);let o=!1;t.forEach((t,i)=>{const c=Object(r["l"])(n)?n[i]:null,d=s.get(i);for(const{featureIndex:s,value:r,featureId:n}of t)c&&(c[s]=r,o=!0,a=!0),e.attributeOverrides.updateValue(n,d,r)}),o&&e.setAttributeData(i,n,null)}),a&&e.clearMemCache()}function d(e,t){const i=t.edits.updateFeatures;if(!i||0===i.length)return new b;const s=u(t),r=new b,n=new Map;for(let a=0;a<e.attributeStorageInfo.length;a++)n.set(e.attributeStorageInfo[a].name,a);const o=e.fieldsIndex,c=e.objectIdField,d=i.filter(e=>{const t=Object(a["a"])(o,e.attributes,c);return s.has(t)});return e.forEachNode((t,i)=>{const s=new Set(i);for(const n of d){const d=Object(a["a"])(o,n.attributes,c);if(!s.has(d))continue;const h=i.indexOf(d);for(const i in n.attributes){const s=e.fieldsIndex.normalizeFieldName(i),a=l(r,t.index,s),o=n.attributes[i];a.push({featureIndex:h,featureId:d,value:o})}}}),r}function l(e,t,i){const s=h(e,t),r=s.get(i);if(r)return r;const a=new Array;return s.set(i,a),a}function h(e,t){const i=e.get(t);if(i)return i;const s=new p;return e.set(t,s),s}function u(e){const t=new Set;if(!e.updatedFeatures)return t;for(const i of e.updatedFeatures)null!=i.objectId&&null==i.error&&t.add(i.objectId);return t}const p=Map,b=Map},e315:function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var s=i("a4ee"),r=i("59b2"),a=(i("b50f"),i("c120"),i("cea0"),i("c0d3"),i("0b86"),i("2524"),i("365a"));class n extends a["a"]{constructor(){super(...arguments),this.layer=null,this.filter=null}get availableFields(){return[]}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){throw new Error("Not implemented")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(e){throw new Error("Not implemented")}queryFeatures(e,t){throw new Error("Not implemented")}queryObjectIds(e,t){throw new Error("Not implemented")}queryFeatureCount(e,t){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,t){throw new Error("Not implemented")}}Object(s["a"])([Object(r["b"])()],n.prototype,"layer",void 0),Object(s["a"])([Object(r["b"])()],n.prototype,"availableFields",null),Object(s["a"])([Object(r["b"])()],n.prototype,"maximumNumberOfFeatures",null),Object(s["a"])([Object(r["b"])({readOnly:!0})],n.prototype,"maximumNumberOfFeaturesExceeded",null),Object(s["a"])([Object(r["b"])()],n.prototype,"filter",void 0)},ebae:function(e,t,i){"use strict";i.d(t,"a",(function(){return b}));var s=i("a4ee"),r=i("fc29"),a=i("af40"),n=i("3795"),o=i("59b2"),c=(i("b50f"),i("c120"),i("cea0"),i("d386")),d=i("f694"),l=i("6b38"),h=i("9305");const u=1.2;let p=class extends r["a"]{constructor(){super(...arguments),this.suspended=!1,this.extent=null,this.extentIntersectionDirty=!0,this._isVisibleBelowSurface=!1,this.handles=new a["a"],this.layerView=null,this.updating=!0}setup(e){this.layerView=e,this.extentIntersection=new l["a"]({renderCoordsHelper:e.view.renderCoordsHelper});const t=e.view,i=t.basemapTerrain,s=t.resourceController.scheduler;this.handles.add([t.on("resize",()=>this.viewChange()),t.state.watch("camera",()=>this.viewChange(),!0),s.registerTask(h["b"].FRUSTUM_VISIBILITY,this),i.on("elevation-bounds-change",()=>this.elevationBoundsChange())]),"local"===t.viewingMode?this.isVisibleBelowSurface=!0:this.handles.add([Object(n["a"])(i,["opacity","wireframe"],()=>this.updateIsVisibleBelowSurface()),Object(n["a"])(t,"map.ground.navigationConstraint.type",()=>this.updateIsVisibleBelowSurface())])}destroy(){this.layerView=null,this.extent=null,this.extentIntersection=null,this.handles&&(this.handles.destroy(),this.handles=null)}_setDirty(){this.updating||this._set("updating",!0)}setExtent(e){this.extent=e,this.extentIntersectionDirty=!0,this._setDirty()}viewChange(){this._setDirty()}elevationBoundsChange(){this._setDirty(),this.extentIntersectionDirty=!0}set isVisibleBelowSurface(e){this._isVisibleBelowSurface=e,this._setDirty(),this.extentIntersectionDirty=!0}updateIsVisibleBelowSurface(){const e=this.layerView.view,t=e.basemapTerrain,i="local"===e.viewingMode,s=e.map.ground&&e.map.ground.navigationConstraint&&"none"===e.map.ground.navigationConstraint.type;this.isVisibleBelowSurface=i||!t.opaque||s}updateExtentIntersection(){if(!this.extentIntersectionDirty)return;this.extentIntersectionDirty=!1;const e=this.layerView.view;let t;if(this._isVisibleBelowSurface)t=-.3*Object(d["e"])(e.spatialReference).radius;else{const{min:i,max:s}=e.basemapTerrain.elevationBounds;t=i-Math.max(1,(s-i)*(u-1))}this.extentIntersection.update(this.extent,e.spatialReference,t)}get running(){return this.updating}runTask(){if(this._set("updating",!1),!this.extent)return void this._set("suspended",!1);this.updateExtentIntersection();const e=this.layerView.view.frustum,t=Object(d["e"])(this.layerView.view.spatialReference).radius;this._set("suspended",!this.extentIntersection.isVisibleInFrustum(e,t))}};Object(s["a"])([Object(o["b"])({readOnly:!0})],p.prototype,"suspended",void 0),Object(s["a"])([Object(o["b"])({readOnly:!0})],p.prototype,"updating",void 0),p=Object(s["a"])([Object(c["a"])("esri.views.3d.layers.graphics.Graphics3DFrustumVisibility")],p);const b=p},f426:function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var s=i("c1da");function r(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){const{layer:e,layer:{fieldsIndex:t},requiredFields:i}=this;return e.outFields?Object(s["j"])(t,[...Object(s["v"])(t,e.outFields),...i]):Object(s["j"])(t,i)}}}}},f7f0:function(e,t,i){"use strict";i.d(t,"a",(function(){return d}));var s=i("a4ee"),r=i("ce50"),a=i("b2b2"),n=(i("e92d"),i("cea0"),i("b50f"),i("c120"),i("2dd4"),i("d386")),o=i("c1da"),c=i("ad73");const d=e=>{let t=class extends e{_validateFetchPopupFeatures(e){const{layer:t}=this,{popupEnabled:i}=t;return i?Object(c["a"])(t,e)?void 0:new r["a"]("scenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{layer:t}):new r["a"]("scenelayerview3d:fetchPopupFeatures","Popups are disabled",{layer:t})}async prepareFetchPopupFeatures(e){}async fetchPopupFeatures(e,t){const i=this._validateFetchPopupFeatures(t);if(i)return Promise.reject(i);const s=Object(a["l"])(t)?t.clientGraphics:null;if(!s||0===s.length)return Promise.resolve([]);const r="scene"===this.layer.type&&Object(a["l"])(this.layer.associatedLayer)?this.layer.associatedLayer:this.layer,n=Object(o["v"])(this.layer.fieldsIndex,await Object(c["b"])(r,Object(c["a"])(this.layer,t)));await this.prepareFetchPopupFeatures(n);const d=new Set,l=[],h=[];for(const a of s)Object(o["t"])(n,a,d)?h.push(a):l.push(a);return 0===h.length?Promise.resolve(l):this.whenGraphicAttributes(h,[...d]).catch(()=>h).then(e=>l.concat(e))}};return t=Object(s["a"])([Object(n["a"])("esri.views.3d.layers.support.PopupSceneLayerView")],t),t}}}]);